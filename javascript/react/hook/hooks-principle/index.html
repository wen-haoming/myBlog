<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="stylesheet" href="/umi.css" />
    <script>
      window.routerBase = "/";
    </script>
    <script>
      //! umi version: 3.3.7
    </script>
    <title>react-hooks简单实现</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/javascript/react/hook/hooks-principle" data-show-sidemenu="true" data-show-slugs="false" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" href="/">Ming仔</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span>前端<ul><li><a href="/javascript/base">基础</a></li><li><a href="/javascript/business">业务</a></li><li><a href="/javascript/api">浏览器API</a></li><li><a aria-current="page" class="active" href="/javascript/react">react</a></li><li><a href="/javascript/vue">vue</a></li><li><a href="/javascript/webpack">webpack</a></li><li><a href="/javascript/project">项目实践</a></li></ul></span><span>python<ul><li><a href="/python/base">python语言学习</a></li><li><a href="/python/base2">python程序进阶</a></li><li><a href="/python/neuralnetwork">神经网络基础</a></li><li><a href="/python/tensoflow">Tensoflow</a></li></ul></span><span>书籍</span><span>计算机相关<ul><li><a href="/cs/base">基础</a></li></ul></span><span>杂七杂八<ul><li><a href="/order/efficiency">工作效率</a></li><li><a href="/order/think">个人思考</a></li></ul></span></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" href="/"></a><h1>Ming仔</h1><p></p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li>前端<ul><li><a href="/javascript/base">基础</a></li><li><a href="/javascript/business">业务</a></li><li><a href="/javascript/api">浏览器API</a></li><li><a aria-current="page" class="active" href="/javascript/react">react</a></li><li><a href="/javascript/vue">vue</a></li><li><a href="/javascript/webpack">webpack</a></li><li><a href="/javascript/project">项目实践</a></li></ul></li><li>python<ul><li><a href="/python/base">python语言学习</a></li><li><a href="/python/base2">python程序进阶</a></li><li><a href="/python/neuralnetwork">神经网络基础</a></li><li><a href="/python/tensoflow">Tensoflow</a></li></ul></li><li>书籍</li><li>计算机相关<ul><li><a href="/cs/base">基础</a></li></ul></li><li>杂七杂八<ul><li><a href="/order/efficiency">工作效率</a></li><li><a href="/order/think">个人思考</a></li></ul></li></ul></div><ul class="__dumi-default-menu-list"><li><a aria-current="page" class="active" href="/javascript/react/hook">源码</a><ul><li><a aria-current="page" class="active" href="/javascript/react/hook/hooks-principle"><span>react-hooks简单实现</span></a></li></ul></li><li><a href="/javascript/react/performance">react性能优化</a></li></ul></div></div><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="react-hooks-简单实现"><a aria-hidden="true" tabindex="-1" href="/javascript/react/hook/hooks-principle#react-hooks-简单实现"><span class="icon,icon-link"></span></a>react-hooks 简单实现</h1><p>我们简单实现 react-hooks 的基本环境，以 useState 为例。</p><p>你能够收获</p><ul><li>hooks 的数据在 react 中是如何通过链表的形式保留下来的。</li><li>进一步熟悉链表的操作，比如环状链表，单向链表的简单操作。</li></ul><blockquote><p>以 const [num,setNum] = useState(0) 为例，每次组件渲染的时候， <code>useState</code> 会把上一次的结果都在内部计算出来，而 <code>setNum</code> 只是在上一次更新的时候都记录下来并且放到当前hook的链表中。</p></blockquote><p>首先每个组件都有自己对应的 fiber, 并且每个 fiber 存储着自身的节点还有节点一切所使用的 hook，其中 hook 是使用链表串联起来(这也是为什么 hook 不能在条件判断中出现，这样就会有可能导致链表寻找下一个节点失败)，返回一个对象有这一个 <code>onClick</code> 的函数，这样做是为了后面验证和调试方便。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> fiber </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    stateNode</span><span class="token punctuation">:</span><span class="token maybe-class-name">App</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 存储当前节点</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    memoizedState</span><span class="token punctuation">:</span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token comment">// 存储一些列 hook</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function maybe-class-name">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">num</span><span class="token punctuation">,</span><span class="token plain">setNum</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token function">setNum</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token arrow operator">=&gt;</span><span class="token plain">num</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token comment">// useState 的 action 我们先以函数的形式。</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h2 id="运行阶段"><a aria-hidden="true" tabindex="-1" href="/javascript/react/hook/hooks-principle#运行阶段"><span class="icon,icon-link"></span></a>运行阶段</h2><p>支撑我们 app 能运行（刷新）起来需要这个 <code>schedule</code> 函数。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> fiber </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    stateNode</span><span class="token punctuation">:</span><span class="token maybe-class-name">App</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 存储当前节点</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    memoizedState</span><span class="token punctuation">:</span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token comment">// 存储一些列 hook</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    fiber</span><span class="token punctuation">.</span><span class="token method function property-access">stateNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 触发组件的render</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>不过 <code>schedule</code> 仅仅是执行，我们需要区分的是组件是挂载(<strong>mount</strong>) 还是更新(<strong>update</strong>)，所以当第一次执行是 <code>isMount=true</code> 当后续继续执行的时候就是 <code>isMount=false</code> 代表其实组件更新的状态。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">let</span><span class="token plain"> isMount </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">;</span><span class="token plain"> </span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    fiber</span><span class="token punctuation">.</span><span class="token method function property-access">stateNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 触发组件的render</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    isMount </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>另外我们需要全局声明一个变量 <code>workInProgressHooks</code> 的指针来指向当前需要运行的hook</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">let</span><span class="token plain"> workInProgressHooks </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 指向我们当前运行hooks的指针</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> fiber </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    stateNode</span><span class="token punctuation">:</span><span class="token maybe-class-name">App</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    memoizedState</span><span class="token punctuation">:</span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token comment">// 保存对应hooks的数据 </span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    workInProgressHooks </span><span class="token operator">=</span><span class="token plain"> fiber</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">   </span><span class="token keyword">const</span><span class="token plain"> app </span><span class="token operator">=</span><span class="token plain">  fiber</span><span class="token punctuation">.</span><span class="token method function property-access">stateNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 触发组件的render</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    isMount </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> app</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>以上代码的完整展示</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">let</span><span class="token plain"> isMount </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">let</span><span class="token plain"> workInProgressHooks </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 指向我们当前运行hooks的指针</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 每种组件都有自己对应的fiber节点</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> fiber </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    stateNode</span><span class="token punctuation">:</span><span class="token maybe-class-name">App</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    memoizedState</span><span class="token punctuation">:</span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token comment">// 保存对应hooks的数据 </span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token parameter">initialState</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 支撑我们mini react-hooks能运行起来需要这个 schedule 函数</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    workInProgressHooks </span><span class="token operator">=</span><span class="token plain"> fiber</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">   </span><span class="token keyword">const</span><span class="token plain"> app </span><span class="token operator">=</span><span class="token plain">  fiber</span><span class="token punctuation">.</span><span class="token method function property-access">stateNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 触发组件的render</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    isMount </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> app</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function maybe-class-name">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">num</span><span class="token punctuation">,</span><span class="token plain">updateNum</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                </span><span class="token function">setNum</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token arrow operator">=&gt;</span><span class="token plain">num</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access">app</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h2 id="编写usestate"><a aria-hidden="true" tabindex="-1" href="/javascript/react/hook/hooks-principle#编写usestate"><span class="icon,icon-link"></span></a>编写useState</h2><p>首先我们需要定义一个变量 <code>hook</code> 因为 <code>useState</code> 可能在一个组件多次调用，那么我们需要用它来找到对应的是哪个 <code>hook</code> , 并且我们需要区分挂载(<strong>mount</strong>) 还是更新(<strong>update</strong>)状态。</p><ul><li>如果是首次渲染的时候就创建一个 <code>hook</code>，利用 <code>workInProgressHook</code> 这个变量来记录</li><li>如果是更新的话就拿取 拿取最新的 <code>workInProgressHook</code> 即可</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token parameter">initialState</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">let</span><span class="token plain"> hook</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token plain">isMount</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        hook </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          memoizedState</span><span class="token punctuation">:</span><span class="token plain">initialState</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 创建的时候对应的 hook 的 memoizedState 就是 initialState</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          next</span><span class="token punctuation">:</span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          queue</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            pending</span><span class="token punctuation">:</span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token comment">// 如果我们调用多次 action 的时候就会把它放进</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">fiber</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            fiber</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> hook</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 如果没有值的话 memoizedState 的第一个就是它</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            workInProgressHook</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> hook </span><span class="token comment">// 在mount 阶段里 组件有多个 useState 的话，需要把每个useState的状态串联起来</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        workInProgressHook </span><span class="token operator">=</span><span class="token plain"> hook</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 复制最新的hook</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        hook  </span><span class="token operator">=</span><span class="token plain"> workInProgressHook </span><span class="token comment">//获取最新的hook</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        workInProgressHook </span><span class="token operator">=</span><span class="token plain"> workInProgressHook</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 更新workInProgressHook的指针，给下一个hook提供最新的状态</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 剩余的代码 我们先把略过</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h2 id="编写-dispatchaction"><a aria-hidden="true" tabindex="-1" href="/javascript/react/hook/hooks-principle#编写-dispatchaction"><span class="icon,icon-link"></span></a>编写 dispatchAction</h2><p><code>useState</code> 我们知道它会返回两个值，其中有一个是改变状态的 <code>action</code>，最重要的问题是，我们如何辨别当前的<code>action</code> 的改变是当前<code>useState</code> 的状态呢？</p><p>官方通过环状链表来解决，每个 <code>hook</code> 都需要绑定一个 <code>queue</code> 的链表来连接每次 <code>update</code> 的状态。(其中由于存在多个状态更新时候的优先级调度问题)。</p><p>接下来我们需要编写 <code>action</code> ，作为改变状态的函数，我们定义为 <code>dispatchAction</code>, 接受两个值<code>queue</code> <code>action</code>。</p><div class="__dumi-default-code-block"><pre class="prism-code language-ts"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">dispatchAction</span><span class="token punctuation">(</span><span class="token parameter">queue</span><span class="token parameter punctuation">,</span><span class="token parameter"> action</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 创建update</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> update </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain">  </span><span class="token comment">// 每次 action 触发的时候</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      action</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      next</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 环状单向链表操作</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">queue</span><span class="token punctuation">.</span><span class="token property-access">pending</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      update</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> update</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 第一就会形成环  u0 -&gt; u0 -&gt; u0 ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      update</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> queue</span><span class="token punctuation">.</span><span class="token property-access">pending</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 注意这里  第二次插入是 u1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      queue</span><span class="token punctuation">.</span><span class="token property-access">pending</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> update</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    queue</span><span class="token punctuation">.</span><span class="token property-access">pending</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> update</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 模拟React开始调度更新</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><img src="/static/hook.84993d4e.png"/><p>接下来就是回到 <code>useState</code> 当每次获取当前最新的 <code>hook</code> 的时候需要遍历当前 <code>hook</code> 中 <code>queue</code>，其中</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token parameter">initialState</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">let</span><span class="token plain"> hook</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">isMount</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        hook </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            queue</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                pending</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            memoizedState</span><span class="token punctuation">:</span><span class="token plain"> initialState</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            next</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">fiber</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            fiber</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> hook</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            workInProgressHook</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> hook</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        workInProgressHook </span><span class="token operator">=</span><span class="token plain"> hook</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        hook </span><span class="token operator">=</span><span class="token plain"> workInProgressHook</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        workInProgressHook </span><span class="token operator">=</span><span class="token plain"> workInProgressHook</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">let</span><span class="token plain"> baseState </span><span class="token operator">=</span><span class="token plain"> hook</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">   </span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token plain">hook</span><span class="token punctuation">.</span><span class="token property-access">queue</span><span class="token punctuation">.</span><span class="token property-access">pending</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">let</span><span class="token plain"> firstUpdate </span><span class="token operator">=</span><span class="token plain"> hook</span><span class="token punctuation">.</span><span class="token property-access">queue</span><span class="token punctuation">.</span><span class="token property-access">pending</span><span class="token plain"> </span><span class="token comment">// 先获取最开始的 update</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">do</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword">let</span><span class="token plain"> action </span><span class="token operator">=</span><span class="token plain"> firstUpdate</span><span class="token punctuation">.</span><span class="token property-access">action</span><span class="token plain"> </span><span class="token comment">// 每次都拿取其中的action</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            baseState </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">action</span><span class="token punctuation">(</span><span class="token plain">baseState</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token comment">// 每次的 action 改变都更新 baseState</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            firstUpdate </span><span class="token operator">=</span><span class="token plain"> firstUpdate</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token plain"> </span><span class="token comment">// 迭代每一次</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token plain">hook</span><span class="token punctuation">.</span><span class="token property-access">queue</span><span class="token punctuation">.</span><span class="token property-access">pending</span><span class="token operator">!==</span><span class="token plain"> firstUpdate</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token comment">// 因为是环状链表，所以判断是前后如果是一致的话就退出</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        hook</span><span class="token punctuation">.</span><span class="token property-access">queue</span><span class="token punctuation">.</span><span class="token property-access">pending</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 迭代完毕就需要把 queue清空</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        hook</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> baseState </span><span class="token comment">// 赋值为最新的 baseState</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    hook</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> baseState</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">baseState</span><span class="token punctuation">,</span><span class="token plain"> dispatchAction</span><span class="token punctuation">.</span><span class="token method function property-access">bind</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> hook</span><span class="token punctuation">.</span><span class="token property-access">queue</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h2 id="最后全部完整的代码"><a aria-hidden="true" tabindex="-1" href="/javascript/react/hook/hooks-principle#最后全部完整的代码"><span class="icon,icon-link"></span></a>最后全部完整的代码</h2><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">let</span><span class="token plain"> isMount </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">let</span><span class="token plain"> workInProgressHook </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 指向我们当前运行hooks的指针</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 每种组件都有自己对应的fiber节点</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> fiber </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    stateNode</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">App</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    memoizedState</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token comment">// 保存对应hooks的数据 </span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token parameter">initialState</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">let</span><span class="token plain"> hook</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">isMount</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        hook </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            queue</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                pending</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            memoizedState</span><span class="token punctuation">:</span><span class="token plain"> initialState</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            next</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">fiber</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            fiber</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> hook</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            workInProgressHook</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> hook</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        workInProgressHook </span><span class="token operator">=</span><span class="token plain"> hook</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        hook </span><span class="token operator">=</span><span class="token plain"> workInProgressHook</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        workInProgressHook </span><span class="token operator">=</span><span class="token plain"> workInProgressHook</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">let</span><span class="token plain"> baseState </span><span class="token operator">=</span><span class="token plain"> hook</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">hook</span><span class="token punctuation">.</span><span class="token property-access">queue</span><span class="token punctuation">.</span><span class="token property-access">pending</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">let</span><span class="token plain"> firstUpdate </span><span class="token operator">=</span><span class="token plain"> hook</span><span class="token punctuation">.</span><span class="token property-access">queue</span><span class="token punctuation">.</span><span class="token property-access">pending</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">do</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword">const</span><span class="token plain"> action </span><span class="token operator">=</span><span class="token plain"> firstUpdate</span><span class="token punctuation">.</span><span class="token property-access">action</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            baseState </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">action</span><span class="token punctuation">(</span><span class="token plain">baseState</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            firstUpdate </span><span class="token operator">=</span><span class="token plain"> firstUpdate</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">firstUpdate </span><span class="token operator">!==</span><span class="token plain"> hook</span><span class="token punctuation">.</span><span class="token property-access">queue</span><span class="token punctuation">.</span><span class="token property-access">pending</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">        hook</span><span class="token punctuation">.</span><span class="token property-access">queue</span><span class="token punctuation">.</span><span class="token property-access">pending</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    hook</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> baseState</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">baseState</span><span class="token punctuation">,</span><span class="token plain"> dispatchAction</span><span class="token punctuation">.</span><span class="token method function property-access">bind</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> hook</span><span class="token punctuation">.</span><span class="token property-access">queue</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">dispatchAction</span><span class="token punctuation">(</span><span class="token parameter">queue</span><span class="token parameter punctuation">,</span><span class="token parameter"> action</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 创建update</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> update </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      action</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      next</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 环状单向链表操作</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">queue</span><span class="token punctuation">.</span><span class="token property-access">pending</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      update</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> update</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      update</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> queue</span><span class="token punctuation">.</span><span class="token property-access">pending</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      queue</span><span class="token punctuation">.</span><span class="token property-access">pending</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> update</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    queue</span><span class="token punctuation">.</span><span class="token property-access">pending</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> update</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 模拟React开始调度更新</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 支撑我们mini react-hooks能运行起来需要这个 schedule 函数</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    workInProgressHook </span><span class="token operator">=</span><span class="token plain"> fiber</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> app </span><span class="token operator">=</span><span class="token plain"> fiber</span><span class="token punctuation">.</span><span class="token method function property-access">stateNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 触发组件的render</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    isMount </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> app</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function maybe-class-name">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">num</span><span class="token punctuation">,</span><span class="token plain"> updateNum</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token function">updateNum</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> num </span><span class="token operator">+</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access">app</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div></div><div class="__dumi-default-layout-footer-meta"><span data-updated-text="最后更新时间：">2/15/2021 11:46:53</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="/umi.js"></script>
  </body>
</html>
